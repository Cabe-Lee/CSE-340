<% if (title) { %>
<h1><%= title %></h1>
<% } else {
  res.redirect('/')
} %>

<%- messages() %>

<% if (errors) { %>
    <ul class="notice">
        <% const errorsList = (typeof errors.array === 'function') ? errors.array() : errors; %>
        <% errorsList.forEach(error => { %>
            <li><%= error.msg || error %></li>
        <% }) %>
    </ul>
<% } %>

<% if (message) { %>
    <p class="notice"><%= message %></p>
<% } %>

<% if (accountData) { %>
<h2>Account Update</h2>
<form class="account-form" method="POST" action="/account/update">
    <input type="hidden" name="account_id" value="<%= accountData.account_id %>">

    <label for="account_firstname">First Name:</label>
    <input type="text" id="account_firstname" name="account_firstname" required value="<%= typeof account_firstname !== 'undefined' ? account_firstname : accountData.account_firstname %>">

    <label for="account_lastname">Last Name:</label>
    <input type="text" id="account_lastname" name="account_lastname" required value="<%= typeof account_lastname !== 'undefined' ? account_lastname : accountData.account_lastname %>">

    <label for="account_email">Email:</label>
    <input type="email" id="account_email" name="account_email" required value="<%= typeof account_email !== 'undefined' ? account_email : accountData.account_email %>">

    <button type="submit">Update Account</button>
</form>

<h2>Change Password</h2>
<form class="account-form" method="POST" action="/account/update-password">
    <input type="hidden" name="account_id" value="<%= accountData.account_id %>">

    <label for="account_password">New Password:</label>
    <span>Passwords must be at least 12 characters and contain at least 1 number, 1 capital letter and 1 special character</span>
    <div class="password-row">
        <input type="password" id="account_password" name="account_password" required pattern="^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[^a-zA-Z0-9])(?!.*\s).{12,}$">
        <button type="button" class="reveal-password" id="togglePassword" aria-pressed="false" aria-label="Show password">Show</button>
    </div>

    <label for="confirm_password">Confirm New Password:</label>
    <div class="password-row">
        <input type="password" id="confirm_password" name="confirm_password" required>
        <button type="button" class="reveal-password" id="toggleConfirmPassword" aria-pressed="false" aria-label="Show password">Show</button>
    </div>

    <button type="submit">Change Password</button>
</form>
<% } %>

<script>
    (function(){
        const toggle = document.getElementById('togglePassword');
        const pwd = document.getElementById('account_password');
        if (toggle && pwd) {
            toggle.addEventListener('click', function () {
                const isHidden = pwd.type === 'password';
                pwd.type = isHidden ? 'text' : 'password';
                toggle.textContent = isHidden ? 'Hide' : 'Show';
                toggle.setAttribute('aria-pressed', isHidden ? 'true' : 'false');
                toggle.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
            });
        }

        const toggleConfirm = document.getElementById('toggleConfirmPassword');
        const pwdConfirm = document.getElementById('confirm_password');
        if (toggleConfirm && pwdConfirm) {
            toggleConfirm.addEventListener('click', function () {
                const isHidden = pwdConfirm.type === 'password';
                pwdConfirm.type = isHidden ? 'text' : 'password';
                toggleConfirm.textContent = isHidden ? 'Hide' : 'Show';
                toggleConfirm.setAttribute('aria-pressed', isHidden ? 'true' : 'false');
                toggleConfirm.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
            });
        }
    })();

    // Include client-side validation script
    const script = document.createElement('script');
    script.src = '/js/account-update.js';
    document.head.appendChild(script);
</script>
